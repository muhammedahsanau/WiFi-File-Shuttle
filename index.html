<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>File List</title>
    <link rel="stylesheet" href="styles.css" />
  </head>
  <body>
    <br />
    <br />
    <br />
    <br />
    <br />
    <h1>Files in Directory</h1>
    <div id="current-path"></div>
    <ul id="file-list"></ul>
    <form id="uploadForm" enctype="multipart/form-data">
      <input type="file" id="fileInput" name="file" required />
      <table>
        <tr>
          <td>
            <button id="uploadButton" type="button" onclick="uploadFile()">
              Upload File
            </button>
          </td>

          <td>
            <div id="uploadLoading" class="spinner"></div>
          </td>
        </tr>
      </table>
    </form>
    <button onclick="goBack()">Go Back</button>

    <script>
      let currentPath = "";

      async function fetchFiles() {
        try {
          const response = await fetch(
            `/files?dir=${encodeURIComponent(currentPath)}`
          );
          const { path, files } = await response.json();
          currentPath = path;
          document.getElementById(
            "current-path"
          ).textContent = `Current Directory: ${currentPath || "Desktop"}`;
          const fileList = document.getElementById("file-list");
          fileList.innerHTML = "";
          console.log("files:", files);
          files.forEach((file) => {
            const listItem = document.createElement("li");
            if (file.type === "directory") {
              const link = document.createElement("a");
              link.href = "#";
              link.textContent = `${file.name}/ (Created: ${new Date(
                file.created
              ).toLocaleString()})`;
              link.onclick = () => {
                currentPath = path ? `${path}/${file.name}` : file.name;
                fetchFiles();
              };
              listItem.appendChild(link);
            } else {
              const link = document.createElement("a");
              link.href = `/download?path=${encodeURIComponent(
                currentPath ? `${currentPath}/${file.name}` : file.name
              )}`;
              link.textContent = `${file.name} (Created: ${new Date(
                file.created
              ).toLocaleString()})`;
              listItem.appendChild(link);

              // Add delete button
              const deleteButton = document.createElement("button");
              deleteButton.textContent = "Delete";
              deleteButton.onclick = () => deleteFile(file.name);
              listItem.appendChild(deleteButton);
            }
            fileList.appendChild(listItem);
          });
        } catch (error) {
          console.error("Error fetching files:", error);
        }
      }

      function goBack() {
        console.log("onbacl", "currentPath:", currentPath);
        if (!currentPath) return;
        const parts = currentPath.split("/");
        parts.pop();
        currentPath = parts.join("/");
        fetchFiles();
      }

      async function uploadFile() {
        const fileInput = document.getElementById("fileInput");
        const file = fileInput.files[0];

        if (!file) {
          alert("Please select a file to upload.");
          return;
        }

        const formData = new FormData();
        formData.append("file", file);
        formData.append("uploadDir", currentPath);

        // Show loading animation
        const loadingGif = document.getElementById("uploadLoading");
        const uploadButton = document.getElementById("uploadButton");

        loadingGif.style.display = "block";
        // disable upload button
        uploadButton.disabled = true;

        try {
          const response = await fetch("/upload", {
            method: "POST",
            body: formData,
          });

          // Hide loading animation after upload completes
          loadingGif.style.display = "none";
          // enable upload button again
          uploadButton.disabled = false;

          if (!response.ok) {
            const errorMessage = await response.text();
            alert(`Failed to upload file: ${errorMessage}`);
          } else {
            fetchFiles();
            alert("File uploaded successfully.");
            // Optionally, update UI or take further actions
          }
        } catch (error) {
          console.error("Error uploading file:", error);
          alert("An error occurred while uploading file.");
        }
      }

      async function deleteFile(fileName) {
        if (confirm(`Are you sure you want to delete ${fileName}?`)) {
          try {
            const response = await fetch(
              `/delete?path=${encodeURIComponent(
                currentPath ? `${currentPath}/${fileName}` : fileName
              )}`,
              {
                method: "DELETE",
              }
            );

            if (!response.ok) {
              const errorMessage = await response.text();
              alert(`Failed to delete file: ${errorMessage}`);
            } else {
              fetchFiles();
              alert("File deleted successfully.");
            }
          } catch (error) {
            console.error("Error deleting file:", error);
            alert("An error occurred while deleting file.");
          }
        }
      }

      fetchFiles();
    </script>
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <br />
    <footer>Â© 2024 WiFi File Shuttle</footer>
  </body>
</html>
